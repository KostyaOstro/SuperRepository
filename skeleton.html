<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="/javascripts/myLib.js"></script>
    <script src="/javascripts/three.js"></script>
</head>

<body>
    <script>
        var time = 0;
        var w = h = 1024;
        var scene, camera, renderer;
        var canvas, ctx;
        window.onload = function () {

            canvas = document.createElement("canvas");
            canvas.height = h;
            canvas.width = w;
            ctx = canvas.getContext("2d");
            document.body.appendChild(canvas);



            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(65, w / h, 0.01, 2000);
            camera.position.z = 100;
            renderer = new THREE.WebGLRenderer({
                antialias: true
            });
            renderer.setSize(w, h);
            //document.body.appendChild(renderer.domElement);

            skeleton.init();
            animate()
        }

        var text = {
            string: "SKELETON",
            fs: h / 10,
            lh: 1,
            as: [],
            copies:[],
            draw() {
                if (time == 0) {
                    ctx.font = 'bold ' + this.fs + 'px arial';
                    ctx.textAlign = "center";
                    ctx.strokeStyle = "white";
                    ctx.fillStyle = "white";
                    var step = Math.PI * 2 / this.string.length;
                    var sum = 0;
                    for (let i = 0; i < this.string.length; i++) {
                        if (i % 2 == 0) {
                            this.as[i] = (i - 1) * step + random(step / 3, step);
                        } else {
                            this.as[i] = i * step;
                        }
                        //sum+=this.as[i]
                        this.copies[i]=rSeed(6)+3;
                    }
                }
                for (let i = 0; i < this.string.length; i++) {
                    for (let j = 0; j < this.copies[i]; j++) {
                        var angle = time / 100 + this.as[i]-Math.pow(1.5,j)*Math.PI/180;
                        var x = w / 2 + Math.cos(angle) * w / 2.4;
                        var y = h / 2 + Math.sin(angle) * w / 2.4;
                        ctx.save();
                        ctx.translate(x, y);
                        ctx.rotate(angle + Math.PI / 2);
                        if(j==0){
                            ctx.fillText(
                                this.string[i],
                                0,
                                0
                            )
                        }else{
                            ctx.strokeText(
                                this.string[i],
                                0,
                                0
                            )
                        }
                        
                        ctx.restore()
                    }


                }
            }
        }

        var skeleton = {
            num: 32,
            gap: 3,
            segment: [],
            pivot: [],
            all: new THREE.Object3D(),

            init() {

                var material = new THREE.MeshBasicMaterial({
                    //wireframe: true,
                    side: THREE.DoubleSide
                })
                for (let i = 0; i < this.num; i++) {
                    this.segment[i] = {
                        x: 0,
                        y: 0,
                        part: 0,
                        l: [],
                        type: [],
                    }
                    this.segment[i].x = 0;
                    this.segment[i].y = -this.gap * this.num / 2 + this.gap * i;
                    this.segment[i].part = rSeed(20) + 1;

                    this.pivot[i] = new THREE.Object3D();

                    var x = this.segment[i].x;
                    var y = this.segment[i].y;
                    for (let j = 0; j < this.segment[i].part; j++) {
                        this.segment[i].type[j] = rSeed(3);
                        this.segment[i].l[j] = random(10, 40) * Math.sin(i / this.num * Math.PI);

                        switch (this.segment[i].type[j]) {
                            case 0:
                                var geometry2 = new THREE.BoxGeometry(
                                    1,
                                    1,
                                    1
                                );
                                break;
                            case 1:
                                var geometry2 = new THREE.SphereGeometry(
                                    1,
                                    8,
                                    8
                                );
                                break;
                            default:
                                var geometry2 = new THREE.ConeGeometry(
                                    1,
                                    3,
                                    8,
                                );

                        }


                        var end = new THREE.Mesh(geometry2, material);
                        var geometry = new THREE.BoxGeometry(
                            0.2,
                            this.segment[i].l[j],
                            0.2,

                        );
                        var mesh = new THREE.Mesh(geometry, material);
                        var ip = new THREE.Object3D();

                        ip.add(mesh);
                        ip.add(end);

                        end.position.y = this.segment[i].l[j];

                        if (rSeed(10) > 9) {
                            var r = random(3, 15) * Math.sin(i / this.num * Math.PI);;
                            var geometry3 = new THREE.CylinderGeometry(
                                r,
                                r,
                                1,
                                20,
                                1,
                                true,
                                0,
                                Math.PI / 2 * (rSeed(3) + 1)

                            );
                            var mesh2 = new THREE.Mesh(geometry3, material);
                            this.pivot[i].add(mesh2)
                        }

                        var geometry4 = new THREE.SphereGeometry(
                            1,
                            8,
                            8
                        );

                        var mesh4 = new THREE.Mesh(geometry4, material);
                        this.pivot[i].add(mesh4);
                        this.pivot[i].add(ip);
                        mesh.position.y = this.segment[i].l[j] / 2;
                        ip.rotation.z = Math.PI / 2;
                        ip.rotation.y = Math.PI * 2 / this.segment[i].part * j;
                    }
                    this.pivot[i].position.y = y;
                    this.all.add(this.pivot[i]);

                }
                scene.add(this.all)
            }

        }


        function animate() {
            skeleton.all.rotation.x += 0.01;
            skeleton.all.rotation.y += 0.01;
            skeleton.all.rotation.z += 0.01;
            for (let i = 0; i < skeleton.num; i++) {
                skeleton.pivot[i].rotation.z = Math.cos(time / 50 + i / skeleton.num * 5) * Math.PI / 16;
                skeleton.pivot[i].rotation.x = Math.cos(time / 50 + i / skeleton.num * 5) * Math.PI / 16;
                skeleton.pivot[i].rotation.y = Math.PI * 2 / skeleton.num * i + time / 50;

                skeleton.pivot[i].position.x += Math.cos(time / 50 + i / skeleton.num * 7) / 10;
                skeleton.pivot[i].position.z = Math.sin(time / 50 + i / skeleton.num * 3) * 10;
            }
            renderer.render(scene, camera);

            ctx.drawImage(renderer.domElement, 0, 0);
            text.draw();
            requestAnimationFrame(animate);
            time++
        }
    </script>
</body>

</html>