<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="/javascripts/three.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:900" rel="stylesheet">
</head>

<body>
    <script>
        var scene, camera, render;
        var w = h = 1024;
        var time = 0;
        var ctx, canvas;

        canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        document.body.appendChild(canvas);
        ctx = canvas.getContext("2d");
        var gsc = rSeed(5);
        bg = rColor(gsc);
        strokeColor = rColor(gsc);
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, w, h);

        var text = "STRANGE";
        ctx.strokeStyle = strokeColor;
        var fs = h / 10;
        ctx.lineWidth = 2;
        ctx.font = fs + 'px Roboto';
        ctx.textAlign = "center";

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(65, w / h, 0.01, 2000);
        camera.position.set(0, 0, 200);
        scene.add(camera);


        renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
        });
        renderer.setSize(w, h);
        renderer.localClippingEnabled = true;
        renderer.shadowMap.enabled = true;
        //document.body.appendChild(renderer.domElement);
        //renderer.setFaceCulling( THREE.CullFaceFront );//THREE.CullFaceNone
        renderer.shadowMap.type = THREE.BasicShadowMap; //THREE.PCFSoftShadowMap;
        // renderer.gammaInput = true;
        // renderer.gammaOutput = true;


        var ambientLight = new THREE.AmbientLight(0xFFFFFF, 0.7);
        scene.add(ambientLight);


        var dirLight = new THREE.PointLight(0xFF530D, 1);
        scene.add(dirLight);
        dirLight.position.set(100, 300, 100);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.set(1024, 1024);
        //pointLight.shadow.radius = 2;

        dirLight.shadow.bias = -0.01;

        var pointLight2 = new THREE.PointLight(0x1221FF, 1);
        scene.add(pointLight2);
        pointLight2.position.set(0, 300, 100);
        pointLight2.castShadow = true;
        pointLight2.shadow.mapSize.set(1024, 1024);
        //pointLight2.shadow.radius =2;
        pointLight2.shadow.bias = -0.01;
        var color = [
            rColor(gsc),
            rColor(gsc),
            rColor(gsc)
        ];

        function colorInterpolation(x, y, z) {
            var r = Math.floor(hexToRgb(color[0]).r * x * (1 - z) + hexToRgb(color[1]).r * (1 - x) * (1 - z) + hexToRgb(
                color[2]).r * z* (1 - x));
            var g = Math.floor(hexToRgb(color[0]).g * x * (1 - z) + hexToRgb(color[1]).g * (1 - x) * (1 - z) + hexToRgb(
                color[2]).g * z* (1 - x));
            var b = Math.floor(hexToRgb(color[0]).b * x * (1 - z) + hexToRgb(color[1]).b * (1 - x) * (1 - z) + hexToRgb(
                color[2]).b * z* (1 - x));
            var rgb = "rgb(" + r + "," + g + "," + b + ")";
            return rgb
        }


        var units = 7;
        var side = 14;
        var l = units * side;
        var plane = [
            new THREE.Plane(new THREE.Vector3(0, -1, 0), 10),
            new THREE.Plane(new THREE.Vector3(1, 0, 0), 10),
            new THREE.Plane(new THREE.Vector3(0, 0, -1), -10),
            new THREE.Plane(new THREE.Vector3(0, 1, 0), -10),
            new THREE.Plane(new THREE.Vector3(-1, 0, 0), -50),
        ];
        var boxG = new THREE.BoxGeometry(side * 0.95, side * 0.95, side * 0.95);
        var sphereG = new THREE.SphereGeometry(side / 2, 8, 8);


        var pivot = new THREE.Object3D();
        var box = [];
        for (let i = 0; i < units; i++) {
            for (let j = 0; j < units; j++) {
                for (let k = 0; k < units; k++) {
                    var r = Math.floor(i / units * 224) + 32;
                    var g = Math.floor(j / units * 224) + 32;
                    var b = Math.floor(k / units * 224) + 32;
                    var rgb = "rgb(" + r + "," + g + "," + b + ")";
                    var index = box.length;
                    var boxM1 = new THREE.MeshBasicMaterial({
                        color: colorInterpolation(i / units, j / units, k / units), //rgb,
                        //color: rColor(gsc),
                        side: THREE.DoubleSide,
                        clippingPlanes: plane,
                        //roughness: 0,
                        clipShadows: true,
                        clipIntersection: true
                    });
                    if (rSeed(10) > 4) {



                        box[index] = new THREE.Mesh(boxG, boxM1);

                    } else {
                        box[index] = new THREE.Mesh(sphereG, boxM1);
                    }
                    pivot.add(box[index]);
                    box[index].castShadow = true;
                    box[index].receiveShadow = true;
                    box[index].position.set(
                        i * side - units / 2 * side,
                        j * side - units / 2 * side,
                        k * side - units / 2 * side
                    )
                }
            }
        }
        scene.add(pivot)





        animate()

        function animate() {


            for (let i = 0; i < plane.length; i++) {
                var x = Math.cos(time / 50 + i / plane.length);
                var y = Math.sin(time / 100 + i / plane.length);
                var z = Math.sin(time / 80 + i / plane.length);
                plane[i].normal.set(x, y, z)
                plane[i].volume += Math.cos(time / 50 + i / plane.length) * 5
            }

            for (let i = 0; i < box.length; i++) {
                var s = Math.cos(time / 50 + i / plane.length);
                box[i].scale.set(s, s, s)
            }

            pivot.rotation.y += 0.01;
            pivot.rotation.x += 0.01;
            requestAnimationFrame(animate);
            renderer.shadowMap.needsUpdate = true;
            renderer.render(scene, camera);
            ctx.drawImage(renderer.domElement, 0, 0);



            for (let i = 0; i < 4; i++) {
                ctx.save()
                ctx.translate(w / 2, h / 2);
                ctx.rotate(i * Math.PI / 2);

                ctx.fillRect(-w / 4, h / 2.5, w / 2, h / 5)
                ctx.translate(0, h / 1.9);
                ctx.strokeText(
                    text, 0, 0
                )
                ctx.restore()
            }
            time++
        }

        function rColor(s) {
            var seed = Math.round(Math.random() * 4);
            var color = [];
            color[0] = ["#571845", "#900c3e", "#c70039", "#ff5733", "#ffc300"];
            color[1] = ["#96ceb4", "#ffeead", "#ff6f69", "#ffcc5c", "#88d8b0"];
            color[2] = ["#173f5f", "#20639b", "#3caea3", "#f6d55c", "#ed553b"];
            color[3] = ["#999", "#777", "#555", "#333", "#111"];
            color[4] = ["#ffa239", "#c8e6c9", "#81c784", "#4caf50", "#ffe789"];
            color[5] = ["#428", "#6ca2ea", "#b5d33d", "#fed23f", "#eb7d5b"];
            var rgb = color[s][seed];
            return rgb;
        };

        function random(minR, maxR) {
            var r = minR + (maxR - minR) * Math.random();
            return r
        };

        function rSeed(value) {
            var seed = Math.round(Math.random() * value);
            return seed
        };

        function hexToRgb(hex) {
            // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
            var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function (m, r, g, b) {
                return r + r + g + g + b + b;
            });

            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
    </script>
</body>

</html>