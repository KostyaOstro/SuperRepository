<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="/javascripts/three.js"></script>
    <script src="/javascripts/myLib.js"></script>
    <script src="/javascripts/objloader.js"></script>
    <script id="fragmentShader2" type='x-shader/x-fragment'>
        uniform float time;
        uniform sampler2D texture1;
        uniform sampler2D texture2;
        varying vec2 vv;
        varying vec3 n;
        varying vec3 p;
        varying vec4 n2;
        varying vec4 p2;


        mat2 rotate(float angle){
            return mat2(
                cos(angle), - sin(angle),
                sin(angle), cos(angle)
            );
        }

        void main(){
            vec2 fg = fract(vv * 5.);
            vec2 fg2 = gl_FragCoord.xy / 1024.;

            vec2 mv = vv ;
            vec4 img2 = texture2D(texture2, fg);
            mv.y += img2.r / 50.;
            mv.y -= mv.x / 5.;
            mv.y += fract(time / 5.);
            if(mv.y > 1.)mv.y -= 1.;
            mv.x += fract(cos(mv.y * 20.)) / 50.;
            vec4 img = texture2D(texture1, mv);
            float col = img.r ;
            gl_FragColor = vec4(vec3((1. - col) / 2.,0.,0.), 1.);
        }
    </script>
    <script id="fragmentShader" type='x-shader/x-fragment'>
        uniform float time;
        uniform sampler2D texture2;
        varying vec2 vv;
        varying vec3 n;
        varying vec3 p;
        varying vec4 n2;
        varying vec4 p2;


        mat2 rotate(float angle){
            return mat2(
                cos(angle), - sin(angle),
                sin(angle), cos(angle)
            );
        }

        void main(){
            vec2 mv = vv;
            mv -= .5;
            mv *= rotate(time);
            mv += .5;
            mv = fract(mv * 3.);
            vec4 img = texture2D(texture2, mv);
            vec2 fg2 = gl_FragCoord.xy / 1024.;
            vec2 fg = gl_FragCoord.xy / 1024.;
            fg = fract(vv * 30.);
            float w = .1 * vv.y * 18. * fg2.x  ;
            float col = smoothstep(w, w * 0.9, fg.x) + (1. - img.r);
            float col2 = smoothstep(w, w * 0.9, fg.y) + (1. - img.r);
            gl_FragColor = vec4(vec3( col), 1.);
        }
    </script>
    <script id="vertexShader" type='x-shader/x-vertex'>
        uniform float time;
        varying vec2 vv;
        varying vec3 n;
        varying vec3 p;
        varying vec4 n2;
        varying vec4 p2;
        void main(){
            vv = uv;
            n = normal;
            p = position;
            n2 =  modelViewMatrix * vec4(normal, 1.) ;
            p2 =  modelViewMatrix * vec4(position, 1.) ;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.);
        }
    </script>
    <title>Document</title>
</head>

<body>
    <script>
        var time = 0;
        var w = h = 1024;

        var canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        //document.body.appendChild(canvas);
        var ctx = canvas.getContext("2d");

        var fs = h / 5;
        var lh = .8;
        ctx.font = 'bold ' + fs + 'px Arial';
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, w, h);
        ctx.fillStyle = 'black';
        ctx.textAlign = "center";
        var txt = ["SATANIC", "HORSE"];
        for (let j = 0; j < 10; j++) {
            ctx.fillText(
                txt[j % txt.length],
                w / 2,
                fs * lh + j * lh * fs
            )
        }
        var tex2 = new THREE.TextureLoader().load("/images/pentagram.png");

        if (ctx) {


            var bd, bg;
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera(65, w / h, .01, 2000);
            camera.position.z = 100;
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(w, h);
            document.body.appendChild(renderer.domElement);
            var tex = new THREE.CanvasTexture(canvas);
           
            var uniforms = {
                time: {
                    type: 'f',
                    value: 0,
                },
                "texture1":{
                    value: tex
                },
                "texture2":{
                    value: tex2
                }
            }


            var mesh = [];
            var hairs = new THREE.Object3D();
            var hairs2 = new THREE.Object3D();
            var all = new THREE.Object3D();
            var fleg = new THREE.Object3D();
            var bleg = new THREE.Object3D();
            var head = new THREE.Object3D();
            var obj = new THREE.OBJLoader();
            var material = new THREE.ShaderMaterial({
                fragmentShader: document.getElementById('fragmentShader').textContent,
                vertexShader: document.getElementById('vertexShader').textContent,
                uniforms: uniforms
            });
            var material2 = new THREE.ShaderMaterial({
                fragmentShader: document.getElementById('fragmentShader2').textContent,
                vertexShader: document.getElementById('vertexShader').textContent,
                uniforms: uniforms
            });
            obj.load(
                '/obj/horse.obj',
                function (obj) {
                    obj.traverse(
                        function (children) {
                            if (children.isMesh) {
                                console.log(children);
                                let index = mesh.length;
                                var geometry = children.geometry;

                                mesh[index] = new THREE.Mesh(geometry, material);



                            }
                        }
                    )
                    for (let i = 0; i < mesh.length; i++) {
                        switch (i) {
                            case 0:
                                all.add(mesh[0]);
                                mesh[0].position.x += .7;
                                mesh[0].position.y -= .7;

                                var lmaterial = new THREE.LineBasicMaterial()
                                for (let j = 0; j < 30; j++){
                                    var g = new THREE.Geometry();
                                    for (let ii = 0; ii < 50; ii++){
                                        let x = ii * .08 * Math.sin( j / 30 * Math.PI);
                                        let y = z = 0;
                                        g.vertices.push(new THREE.Vector3(x,y,z))
                                    }
                                    var line = new THREE.Line(g, lmaterial);
                                    line.rotation.z = j * .02;
                                    hairs2.add(line);
                                }
                                hairs2.position.set(1.7, .5, -1);
                                mesh[0].add(hairs2)





                                break;
                            case 2:
                                
                                mesh[2].add(mesh[1]);
                                bleg.add(mesh[2]);
                                mesh[1].position.y -= 1.78;
                                mesh[1].position.x -= .7;
                                mesh[2].rotation.z =  Math.PI / 4 * 0;

                                for (let j = 0; j < 5; j++){
                                    var child = mesh[2].clone();
                                    child.position.x -= .2;
                                    bleg.add(child);
                                    child.rotation.z = Math.PI / 5 * j;
                                }
                              

                                bleg.position.x += 2;
                                break;
                            case 4:
                                fleg.add(mesh[i]);
                                mesh[i].add(mesh[3]);
                                mesh[3].position.y -= .9;
                                mesh[3].position.x -= .85;
                                mesh[3].rotation.z -= Math.PI / 4;

                                for (let j = 0; j < 5; j++){
                                    var child = mesh[4].clone();
                                   
                                    fleg.add(child);
                                    child.rotation.z = Math.PI / 5 * j;
                                }

                                fleg.position.x -= 1.3;
                                fleg.position.y -= .9;
                                break;
                            case 5:
                                head.add(mesh[5]);
                                mesh[5].add(mesh[6]);
                                mesh[6].position.x -= 1.4;
                                mesh[6].position.y += 1.1;
                                head.position.x -= 1;
                                var lmaterial = new THREE.LineBasicMaterial()
                                for (let j = 0; j < 30; j++){
                                    var g = new THREE.Geometry();
                                    for (let ii = 0; ii < 50; ii++){
                                        let x = ii * .08 * Math.sin( j / 30 * Math.PI);
                                        let y = z = 0;
                                        g.vertices.push(new THREE.Vector3(x,y,z))
                                    }
                                    var line = new THREE.Line(g, lmaterial);
                                    line.position.y -= j * .06;
                                    line.position.x += j * .05;
                                    hairs.add(line);
                                }
                                hairs.position.set(-1.7, 2, -1);
                                mesh[5].add(hairs)

                                break;


                        };
                    }



                    var geometry = new THREE.PlaneGeometry(200, 200);
                    bg = new THREE.Mesh(geometry, material2);
                    scene.add(bg);
                    bg.position.z -= 50;
                    all.add(bleg);
                    all.add(fleg);
                    all.add(head);
                    scene.add(all);

                    var s = 13;
                    all.scale.set(s, s, s);
                    all.position.x -= 10;

                },
                function () {},
                function () {}
            )




            animate()
        }

        function animate() {
            if (mesh[5]) {
                for (let i = 0; i < fleg.children.length; i++) {
                    
                    fleg.children[i].rotation.z += .01 + Math.cos(time + i / 5 * 3) / 100;
                    bleg.children[i].rotation.z += .01 + Math.cos(time + i / 5 * 3) / 100;
                    bleg.children[i].children[0].rotation.z -= Math.cos(time + i / 5 * 3) / 100;
                    fleg.children[i].children[0].rotation.z -= Math.cos(time + i / 5 * 3) / 100
                }
               
                bleg.rotation.z += 0.01;
                fleg.rotation.z += 0.01;
                mesh[5].rotation.z += Math.cos(time) / 100;
                mesh[6].rotation.z += Math.cos(time) / 100;
                var l1 = hairs.children.length;
                for (let i = 0; i < l1; i++) {
                    var ll = hairs.children[i].geometry.vertices.length;
                    for (let j = 0; j < ll; j++) {
                        hairs.children[i].geometry.vertices[j].y += 
                            Math.cos(time * 5 + j / ll * 7 ) * 
                            Math.sin(time * 7 + i / l1 * 8)*
                            (j / ll) * 
                            0.03;
                        hairs.children[i].geometry.vertices[j].x += 
                            Math.cos(time * 5 + j / ll * 7 ) * 
                            Math.sin(time * 7 + i / l1 * 8)*
                            (j / ll) * 
                            0.01;
                      

                    }
                    hairs.children[i].geometry.verticesNeedUpdate = true;
                }
                var l2 = hairs2.children.length;
                for (let i = 0; i < l1; i++) {
                    var ll2 = hairs2.children[i].geometry.vertices.length;
                    for (let j = 0; j < ll; j++) {
                        hairs2.children[i].geometry.vertices[j].y += 
                            Math.sin(time * 3 + j / ll * 4 ) * 
                            Math.sin(time * 4 + i / l1 * 8)*
                            (j / ll) * 
                            0.03;
                      

                    }
                    hairs2.children[i].geometry.verticesNeedUpdate = true;
                }
            }
          
            all.rotation.z = Math.cos(time) / 5.;
            uniforms.time.value = time;
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
            time += .01;
        }
    </script>
</body>

</html>