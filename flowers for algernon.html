<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            padding: 0px;
            margin: 0px
        }
    </style>

</head>
<script src="javascripts/three.js"></script>
<script src="javascripts/orbitcontrols.js"></script>

<body>
    <script>
        var time = 0;

        var grid = {
            h: 3,
            v: 3,
            side: 300,
            border: 30,
            padding: 5,
            get copies() {
                return this.h * this.v;
            }
        }
        var w = grid.h * grid.side + grid.border * 2;
        var h = grid.v * grid.side + grid.border * 2;

        var canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        //document.body.appendChild(canvas);
        
        var ctx = canvas.getContext("2d");
        //canvas.style.position = "absolute";

        var canvas2 = document.createElement('canvas');
        canvas2.width = w;
        canvas2.height = h;
       
       // document.body.appendChild(canvas2);
        
        var ctx2 = canvas2.getContext("2d");


        var canvas3 = document.createElement('canvas');
        canvas3.width = w;
        canvas3.height = h;
       
        document.body.appendChild(canvas3);
        
        var ctx3 = canvas3.getContext("2d");
        //canvas2.style.position = "absolute"
        var draMa = [];
        function icolor(index){
            var r=0;//Math.sin(index/grid.copies*Math.PI)*64+128;
            var g=Math.round(Math.random()*64)+128;//Math.cos(index/grid.copies*Math.PI/2)*64+128;
            var b=Math.round(Math.random()*64)+128;//Math.sin(index/grid.copies*Math.PI)*64+128;
            var rgb="rgb("+r+","+g+","+b+")";
            return rgb
        }
        for (ii = 0; ii < grid.v; ii++) {
            for (jj = 0; jj < grid.h; jj++) {
                var index = draMa.length;
                draMa[index] = {
                    x: grid.border + jj * grid.side + grid.side / 2,
                    y: grid.border + ii * grid.side + grid.side / 2,
                    radius: (grid.side / 2 - grid.padding) * Math.random(),
                    color:icolor(index),
                    branches: [],
                    draw: function () {
                        constructDraMa(this)
                    }
                };
                var seed = Math.round(Math.random() * 2) + 1;
                // draMa[draMa.length].branches[];
                for (ss = 0; ss < seed; ss++) {
                    var b = {
                        length: (grid.side / 4 - grid.padding) * Math.random()+(grid.side / 4 - grid.padding),
                        angle: Math.PI/2*Math.round(Math.random() * 4),
                        angleSpeed: Math.PI / (Math.round(Math.random() * 50)+50),
                        points: [{
                            speed: Math.random() / 10
                        }],
                    };

                    draMa[index].branches.push(b);
                }
            }

        }
        animate();
        var circle=2;
        var line=1;
        function constructDraMa(obj) {
            ctx.lineWidth=line;
            ctx.beginPath();
            ctx.arc(obj.x, obj.y, circle, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
            for (i = 0; i < obj.branches.length; i++) {
                var b = obj.branches[i];
                ctx.beginPath();
                ctx.moveTo(obj.x, obj.y);
                var speed = b.angle + time / 100;
                var x2 = Math.cos(speed) * b.length + obj.x;
                var y2 = Math.sin(speed) * b.length + obj.y;
                ctx.lineTo(x2, y2);
                ctx.stroke();
                for (j = 0; j < b.points.length; j++) {
                    var d = b.length / 2 + Math.cos(b.points[j].speed * time) * b.length / 2;
                    var px = d * Math.cos(speed) + obj.x;
                    var py = d * Math.sin(speed) + obj.y;
                    ctx.beginPath();
                    ctx.arc(px, py, circle, 0, Math.PI * 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx2.fillStyle = obj.color;
                    ctx2.beginPath();
                    ctx2.arc(px, py, 1, 0, Math.PI * 2);
                    ctx2.closePath();
                    ctx2.fill();

                }
            }
        }

        function draw() {
            for (var i = 0; i < grid.copies; i++) {
                //console.log('hi');
                draMa[i].draw()
            }
            ctx3.drawImage(canvas2,0,0);
            ctx3.drawImage(canvas,0,0)
        }

        function animate() {

            frameClear();
            draw();
            requestAnimationFrame(animate);
            time++
        }



        function frameClear() {
            ctx3.clearRect(0, 0, w, h);
            ctx.clearRect(0, 0, w, h);
        }
    </script>

</body>

</html>