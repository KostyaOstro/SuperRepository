<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="/javascripts/three.js"></script>
    <script src="/javascripts/objloader.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Staatliches" rel="stylesheet">
</head>

<body>
    <script>
        var w = h = 1024;
        var mesh = [];
        var feather = [];
        var ipivot = [];
        var num = 20;
        var pivot;
        var time = 0;
        var gsc = rSeed(5);

        var canvas = document.createElement("canvas");
        canvas.height = w;
        canvas.width = w;
        //document.body.appendChild(canvas);
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, w, h);

        ctx.textAlign = 'center';
        ctx.fillStyle = 'white';
        var string = 'FLOWER';
        var fs = w / 20;
        ctx.font = fs + 'px Staatliches';
        var sum = 0;
        var
        let = -1;
        for (let i = 0; i < 9; i++) {
            if (i % 3 == 0) {
                sum = 0;
                var v = rSeed(1);
                sum += v;
                let += v;
            } else {
                if ((i - 1) % 3 == 0) {
                    if (sum == 0) {
                        var v = 1
                        sum += v;
                        let += v;
                    } else {
                        var v = rSeed(1);
                        sum += v;
                        let += v;
                    }
                } else {
                    if (sum == 2) {
                        var v = 0
                    } else {
                        var v = 1
                        let += v;
                    }
                }
            }
            var value = (v == 1) ? string[let] : "â€”";
            ctx.fillText(
                value,
                w / 4 * (i % 3) + w / 4,
                w / 4 * Math.floor(i / 3) + w / 4
            );
        }






        var scene = new THREE.Scene({

        });
        scene.background = new THREE.Color(rColor(gsc));
        var camera = new THREE.PerspectiveCamera(65, w / h, 0.01, 2000);
        camera.position.set(0, 0, 250);
        var renderer = new THREE.WebGLRenderer({
            anialias: true
        });

        var ambientLight = new THREE.AmbientLight(0xcccccc, 0.8);

        scene.add(ambientLight);
        var pointLight = new THREE.PointLight(0xffffff, 1);
        scene.add(pointLight);
        pointLight.position.set(250, 100, 300);
        pointLight.castShadow = true;

        pointLight.shadow.mapSize.width = 4096; // default
        pointLight.shadow.mapSize.height = 4096; // default
        pointLight.shadow.camera.near = 0.1; // default
        pointLight.shadow.camera.far = 1000 // default




        renderer.setSize(w, h);
        renderer.shadowMap.enabled = true;
        //renderer.physicallyCorrectLights=true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        var pivot = new THREE.Object3D();



        document.body.appendChild(renderer.domElement);
        var loader = new THREE.OBJLoader();
        loader.load(
            '/obj/feathers.obj',
            function (obj) {
                // obj.traverse(
                //     function (child) {
                //         if (child.isMesh) {

                //             g = child.geometry;
                //             //console.log(obj);
                //             mesh.push(g)
                //         }

                //     }
                // );

                for (let i = 0; i < num; i++) {
                    var material = new THREE.MeshPhongMaterial({
                        side: THREE.DoubleSide,
                        color: rColor(gsc)
                    });

                    feather[i] = new THREE.Mesh(mesh[rSeed(mesh.length - 1)], material);



                    // if(i%2==0){
                    //     material.wireframe=true
                    // }
                    feather[i].rotation.x = Math.PI * 2 / num * i;
                    feather[i].rotation.y = Math.PI * 2 / num * i;
                    feather[i].rotation.z = i;
                    var s = Math.cos(i / num * 3) * 50;
                    feather[i].scale.set(s, s, s);

                    ipivot[i] = new THREE.Object3D();
                    ipivot[i].rotation.x = i; //+rSeed(3);

                    ipivot[i].add(feather[i]);
                    feather[i].castShadow = true; //default is false
                    feather[i].receiveShadow = true;
                    pivot.add(ipivot[i]);
                }
                scene.add(pivot)
            },
            function onprogress() {

            },
            function error() {

            }
        )
        var tex = new THREE.CanvasTexture(canvas);
        var planeg = new THREE.PlaneGeometry(20, 20, 1, 1);
        var planem = new THREE.MeshBasicMaterial({
            //wireframe:true,
            alphaMap: tex,
            //map:tex
            transparent: true
        });
        var plane = new THREE.Mesh(planeg, planem);
        plane.position.z = 238;
        scene.add(plane)


        animate();

        function animate() {
            // pivot.rotation.x += 0.01
            // pivot.rotation.z += 0.01;
            // pivot.rotation.y += 0.01
            // if (feather[0]) {
            //     for (let i = 0; i < num; i++) {
            //         ipivot[i].rotation.x += 0.01;
            //         ipivot[i].position.x = Math.cos(time / 50 + i / num * 3) * 20;
            //         var s = Math.cos(time / 50 + i / num);
            //         ipivot[i].scale.set(s, s, s);

            //         feather[i].rotation.x += 0.01;
            //         feather[i].rotation.z += 0.01;
            //         feather[i].rotation.y += 0.01;
            //     }
            // };
            renderer.shadowMap.needsUpdate = true;
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
            time++
        }

        function rColor(s) {
            var seed = Math.round(Math.random() * 4);
            var color = [];
            color[0] = ["#571845", "#900c3e", "#c70039", "#ff5733", "#ffc300"];
            color[1] = ["#96ceb4", "#ffeead", "#ff6f69", "#ffcc5c", "#88d8b0"];
            color[2] = ["#173f5f", "#20639b", "#3caea3", "#f6d55c", "#ed553b"];
            color[3] = ["#999", "#777", "#555", "#333", "#111"];
            color[4] = ["#ffa239", "#c8e6c9", "#81c784", "#4caf50", "#ffe789"];
            color[5] = ["#428", "#6ca2ea", "#b5d33d", "#fed23f", "#eb7d5b"];
            var rgb = color[s][seed];
            return rgb;
        };

        function random(minR, maxR) {
            var r = minR + (maxR - minR) * Math.random();
            return r
        };

        function rSeed(value) {
            var seed = Math.round(Math.random() * value);
            return seed
        };
    </script>
</body>

</html>