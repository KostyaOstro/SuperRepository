<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="/javascripts/three.js"></script>
    <script src="/javascripts/objloader.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:900" rel="stylesheet">
</head>

<body>
    <script>
        var w = h = 1024;
        var time = 0;

        var line = [];
        var renderer;
        var canvas;
        var ctx;
        var scene;
        var camera;
        var cylinder = [];
        var mesh = [];
        var pivot;
        window.onload = function () {

            canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;
            document.body.appendChild(canvas);
            ctx = canvas.getContext("2d");






            scene = new THREE.Scene();
            //scene.background = new THREE.Color("red");
            camera = new THREE.PerspectiveCamera(65, w / h, 0.01, 2000);
            renderer = new THREE.WebGLRenderer({
                // antialias: true,
                // alpha: true
            });
            renderer.setSize(w, h);
            //document.body.appendChild(renderer.domElement);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            camera.position.set(0, 0, 100);


            var ambientLight = new THREE.AmbientLight(0xcccccc, 0.1);
            scene.add(ambientLight);

            var pointLight = new THREE.PointLight(0xcccccc, 0.8);
            scene.add(pointLight);
            pointLight.position.set(100, 100, 100);
            pointLight.castShadow = true;
            pointLight.shadow.mapSize.width = 1024; // default
            pointLight.shadow.mapSize.height = 1024; // default
            pointLight.shadow.camera.near = 0.1; // default
            pointLight.shadow.camera.far = 1000 // default

            pivot = new THREE.Object3D();
            var loader = new THREE.OBJLoader();
            loader.load(
                '/obj/heart.obj',
                function (obj) {
                    obj.traverse(
                        function (child) {
                            if (child.isMesh) {
                                var geometry = child.geometry;
                                var material = new THREE.MeshStandardMaterial({
                                    color: "red",
                                    roughness: 0.5,
                                    side: THREE.DoubleSide
                                })
                                var index = mesh.length;
                                mesh[index] = new THREE.Mesh(geometry, material)
                                pivot.add(mesh[index]);
                                mesh[index].castShadow = true;
                                //mesh[index].receiveShadow=true;

                            }
                        }
                    )
                    scene.add(pivot);
                    pivot.castShadow = true;
                    pivot.receiveShadow = true;
                    console.log(pivot.children.length);
                    var s = 30;
                    pivot.scale.set(s, s, s);
                },
                function onprogress() {},
                function onerror() {}
            )

            animate();

        }





        function animate() {
            if (mesh[0]) {
                for (let i = 0; i < mesh.length; i++) {
                    var s = Math.cos(time / 10 + i / mesh.length * 5) * 0.1 + 1.1;
                    if (i != 1 && i != 2 && i != 3 && i != 15) {
                        mesh[i].scale.set(s, s, s);
                    }


                }

            }

            pivot.rotation.y = Math.cos(time / 200) * Math.PI / 9;
            renderer.shadowMap.needsUpdate = true;
            renderer.render(scene, camera);

            ctx.drawImage(renderer.domElement, 0, 0);
            var string = [
                "I know how ",
                "I feel",
                "when I'm",
                "around you",
                "I don 't know",
                "How I feel",
                "when",
                "I 'm around you, ",
                "around you"
            ];
            var fs = h / 15;
            var lh=1.2;
            ctx.font = fs + 'px roboto';
            ctx.strokeStyle = "white";
            for (let i = 0; i < string.length*3; i++) {
                ctx.strokeText(
                    string[i%string.length], 
                    w / 10, 
                    -time % (fs*lh*string.length)+i*fs*lh);
            };

            

            requestAnimationFrame(animate);
            time++
        }




        function rColor(s) {
            var seed = Math.round(Math.random() * 4);
            var color = [];
            color[0] = ["#571845", "#900c3e", "#c70039", "#ff5733", "#ffc300"];
            color[1] = ["#96ceb4", "#ffeead", "#ff6f69", "#ffcc5c", "#88d8b0"];
            color[2] = ["#173f5f", "#20639b", "#3caea3", "#f6d55c", "#ed553b"];
            color[3] = ["#999", "#777", "#555", "#333", "#111"];
            color[4] = ["#ffa239", "#c8e6c9", "#81c784", "#4caf50", "#ffe789"];
            color[5] = ["#428", "#6ca2ea", "#b5d33d", "#fed23f", "#eb7d5b"];
            var rgb = color[s][seed];
            return rgb;
        };

        function random(minR, maxR) {
            var r = minR + (maxR - minR) * Math.random();
            return r
        };

        function rSeed(value) {
            var seed = Math.round(Math.random() * value);
            return seed
        };
    </script>

</body>

</html>